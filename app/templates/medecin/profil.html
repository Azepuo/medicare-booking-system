{% extends "medecin/base.html" %}

{% block title %}Profil • Médecin{% endblock %}
{% block body_id %}profil-page{% endblock %}

{% block content %}
<div class="header-row">
  <h1 class="h1">Mon Profil</h1>
  <div class="header-actions">
    <button class="btn btn-outline" onclick="resetForm()">
      <i class="fas fa-undo"></i> Réinitialiser
    </button>
    <button class="btn btn-primary" onclick="saveProfile()" id="saveBtn">
      <i class="fas fa-save"></i> Enregistrer
    </button>
  </div>
</div>

<div class="alert alert-info" id="messageBox" style="display:none;"></div>

<div class="grid profile-grid">
  <!-- Photo de profil -->
  <div class="card profile-photo-card">
    <h3><i class="fas fa-user-circle mr-10"></i>Photo de Profil</h3>
    <div class="photo-container">
      <div class="profile-avatar" id="profileAvatar">
        <i class="fas fa-user-md"></i>
      </div>
      <div class="photo-actions">
        <input type="file" id="photoInput" accept="image/*" style="display: none;">
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('photoInput').click()">
          <i class="fas fa-camera"></i> Changer la photo
        </button>
        <button class="btn btn-outline btn-sm btn-danger" onclick="removePhoto()">
          <i class="fas fa-trash"></i> Supprimer
        </button>
      </div>
      <small class="text-muted mt-10">Formats acceptés: JPG, PNG, GIF (max 2MB)</small>
    </div>
  </div>

  <!-- Informations personnelles -->
  <div class="card profile-info-card">
    <h3><i class="fas fa-id-card mr-10"></i>Informations Personnelles</h3>
    
    <div class="form-group">
      <label class="form-label"><i class="fas fa-user mr-5"></i> Nom Complet *</label>
      <div class="input-group">
        <input type="text" class="input" id="nomComplet" value="{{ user.nom_complet if user else '' }}" required>
        <div class="input-icon"><i class="fas fa-user"></i></div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group" style="flex: 1;">
        <label class="form-label"><i class="fas fa-envelope mr-5"></i> Email *</label>
        <div class="input-group">
          <input type="email" class="input" id="email" value="{{ user.email if user else '' }}" required>
          <div class="input-icon"><i class="fas fa-at"></i></div>
        </div>
      </div>
      <div class="form-group" style="flex: 1;">
        <label class="form-label"><i class="fas fa-phone mr-5"></i> Téléphone *</label>
        <div class="input-group">
          <input type="text" class="input" id="telephone" value="{{ user.telephone if user else '' }}" required>
          <div class="input-icon"><i class="fas fa-phone-alt"></i></div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label"><i class="fas fa-map-marker-alt mr-5"></i> Adresse</label>
      <div class="input-group">
        <input type="text" class="input" id="adresse" value="{{ user.adresse if user else '' }}">
        <div class="input-icon"><i class="fas fa-home"></i></div>
      </div>
    </div>
  </div>

  <!-- Identifiants de connexion -->
  <div class="card security-card">
    <h3><i class="fas fa-shield-alt mr-10"></i>Sécurité et Identifiants</h3>
    
    <div class="form-group">
      <label class="form-label"><i class="fas fa-user-shield mr-5"></i> Identifiant</label>
      <div class="input-group">
        <input type="text" class="input" id="username" value="{{ user.email if user else '' }}" readonly>
        <div class="input-icon"><i class="fas fa-user-lock"></i></div>
      </div>
      <small class="text-muted">L'email est utilisé comme identifiant</small>
    </div>

    <div class="form-group">
      <label class="form-label"><i class="fas fa-key mr-5"></i> Changer le Mot de Passe</label>
      <div class="input-group">
        <input type="password" class="input" id="password" placeholder="Nouveau mot de passe">
        <div class="input-icon"><i class="fas fa-lock"></i></div>
      </div>
      <div class="input-group mt-10">
        <input type="password" class="input" id="confirm_password" placeholder="Confirmer le mot de passe">
        <div class="input-icon"><i class="fas fa-lock"></i></div>
      </div>
      <small class="text-muted">Laissez vide pour ne pas modifier le mot de passe</small>
    </div>

    <div class="form-group">
      <label class="form-label"><i class="fas fa-calendar mr-5"></i> Date d'Inscription</label>
      <div class="input-group">
        <input type="text" class="input" value="{{ user.date_inscription if user else '' }}" readonly>
        <div class="input-icon"><i class="fas fa-calendar-plus"></i></div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label"><i class="fas fa-user-tag mr-5"></i> Rôle</label>
      <div class="input-group">
        <input type="text" class="input" value="{{ user.role if user else '' }}" readonly>
        <div class="input-icon"><i class="fas fa-user-cog"></i></div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label"><i class="fas fa-id-badge mr-5"></i> ID Utilisateur</label>
      <div class="input-group">
        <input type="text" class="input" value="{{ user.user_id if user else '' }}" readonly>
        <div class="input-icon"><i class="fas fa-id-card"></i></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Routes API
const API = {
  PROFILE: '/medecin/api/profile'
};

// Variables globales
let originalData = {};

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  // Sauvegarder les données originales
  saveOriginalData();
  
  // Configurer l'écoute des modifications
  setupFormListeners();
});

// Sauvegarder les données originales
function saveOriginalData() {
  originalData = {
    nomComplet: document.getElementById('nomComplet').value,
    email: document.getElementById('email').value,
    telephone: document.getElementById('telephone').value,
    adresse: document.getElementById('adresse').value
  };
}

// Configurer les écouteurs de formulaire
function setupFormListeners() {
  // Valider l'email
  const emailInput = document.getElementById('email');
  emailInput.addEventListener('blur', function() {
    if (this.value && !isValidEmail(this.value)) {
      this.classList.add('input-error');
      showMessage('error', 'Format d\'email invalide.');
    } else {
      this.classList.remove('input-error');
    }
  });
  
  // Valider le téléphone
  const phoneInput = document.getElementById('telephone');
  phoneInput.addEventListener('blur', function() {
    if (this.value && !isValidPhone(this.value)) {
      this.classList.add('input-error');
      showMessage('error', 'Format de téléphone invalide.');
    } else {
      this.classList.remove('input-error');
    }
  });
}

// Validation
function isValidEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function isValidPhone(phone) {
  const re = /^[\d\s.\-+()]{10,20}$/;
  return re.test(phone);
}

// Sauvegarder le profil
async function saveProfile() {
  // Validation des champs requis
  const requiredFields = ['nomComplet', 'email', 'telephone'];
  for (const fieldId of requiredFields) {
    const field = document.getElementById(fieldId);
    if (!field.value.trim()) {
      field.classList.add('input-error');
      showMessage('error', `Le champ "${field.previousElementSibling?.textContent || fieldId}" est requis.`);
      field.focus();
      return;
    }
    field.classList.remove('input-error');
  }
  
  // Validation email
  if (!isValidEmail(document.getElementById('email').value)) {
    showMessage('error', 'Format d\'email invalide.');
    return;
  }
  
  // Validation mot de passe
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirm_password').value;
  if (password || confirmPassword) {
    if (password !== confirmPassword) {
      showMessage('error', 'Les mots de passe ne correspondent pas.');
      return;
    }
    if (password.length < 6) {
      showMessage('error', 'Le mot de passe doit contenir au moins 6 caractères.');
      return;
    }
  }
  
  // Préparer les données (seulement les champs de la table users)
  const data = {
    nom_complet: document.getElementById('nomComplet').value,
    email: document.getElementById('email').value,
    telephone: document.getElementById('telephone').value,
    adresse: document.getElementById('adresse').value
  };
  
  // Ajouter le mot de passe si modifié
  if (password) {
    data.password = password;
  }
  
  // Afficher le chargement
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
  saveBtn.disabled = true;
  
  try {
    const response = await fetch(API.PROFILE, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showMessage('success', 'Profil mis à jour avec succès !');
      saveOriginalData(); // Mettre à jour les données originales
      
      // Réinitialiser les champs de mot de passe
      document.getElementById('password').value = '';
      document.getElementById('confirm_password').value = '';
    } else {
      throw new Error(result.error || 'Erreur lors de la mise à jour');
    }
  } catch (error) {
    showMessage('error', 'Erreur: ' + error.message);
  } finally {
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}

// Réinitialiser le formulaire
function resetForm() {
  if (confirm('Annuler toutes les modifications ?')) {
    document.getElementById('nomComplet').value = originalData.nomComplet || '';
    document.getElementById('email').value = originalData.email || '';
    document.getElementById('telephone').value = originalData.telephone || '';
    document.getElementById('adresse').value = originalData.adresse || '';
    
    // Réinitialiser les champs de mot de passe
    document.getElementById('password').value = '';
    document.getElementById('confirm_password').value = '';
    
    showMessage('info', 'Modifications annulées.');
  }
}

// Afficher un message
function showMessage(type, text) {
  const messageBox = document.getElementById('messageBox');
  messageBox.className = `alert alert-${type}`;
  messageBox.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${text}</span>
    <button class="alert-close" onclick="this.parentElement.style.display='none'">&times;</button>
  `;
  messageBox.style.display = 'flex';
  
  // Masquer automatiquement après 5 secondes sauf pour les erreurs
  if (type !== 'error') {
    setTimeout(() => {
      messageBox.style.display = 'none';
    }, 5000);
  }
}
</script>

<style>
/* Layout simplifié */
.profile-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 20px;
  margin-top: 20px;
}

.profile-photo-card {
  grid-column: span 4;
}

.profile-info-card {
  grid-column: span 8;
}

.security-card {
  grid-column: span 12;
}

@media (max-width: 1200px) {
  .profile-grid {
    grid-template-columns: 1fr;
  }
  
  .profile-photo-card,
  .profile-info-card,
  .security-card {
    grid-column: span 1;
  }
}

/* Styles restants identiques... */



/* Layout */
.profile-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 20px;
  margin-top: 20px;
}

.profile-photo-card {
  grid-column: span 3;
}

.profile-info-card {
  grid-column: span 9;
}

.professional-card {
  grid-column: span 6;
}

.description-card {
  grid-column: span 6;
}

.security-card {
  grid-column: span 12;
}

@media (max-width: 1200px) {
  .profile-grid {
    grid-template-columns: 1fr;
  }
  
  .profile-photo-card,
  .profile-info-card,
  .professional-card,
  .description-card,
  .security-card {
    grid-column: span 1;
  }
}

/* Photo de profil */
.photo-container {
  text-align: center;
  padding: 20px;
}

.profile-avatar {
  width: 150px;
  height: 150px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 50%;
  margin: 0 auto 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 60px;
  background-size: cover;
  background-position: center;
  border: 4px solid white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.photo-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

/* Formulaires */
.form-row {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
}

.form-group {
  margin-bottom: 15px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #495057;
}

.input-group {
  position: relative;
}

.input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.2s;
  box-sizing: border-box;
}

.input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.input-error {
  border-color: #dc3545 !important;
}

.input-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #6c757d;
}

textarea.input {
  min-height: 100px;
  resize: vertical;
}

/* Tags pour spécialités */
.tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  padding: 10px;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  min-height: 45px;
}

.tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #e3f2fd;
  color: #1976d2;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
}

.tag-remove {
  background: none;
  border: none;
  color: #1976d2;
  cursor: pointer;
  padding: 0;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-size: 10px;
}

.tag-remove:hover {
  background: rgba(0,0,0,0.1);
}

/* Checkboxes */
.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  padding: 10px;
  border: 1px solid #dee2e6;
  border-radius: 6px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}

.checkbox-label input {
  display: none;
}

.checkbox-custom {
  width: 18px;
  height: 18px;
  border: 2px solid #dee2e6;
  border-radius: 4px;
  position: relative;
  transition: all 0.2s;
}

.checkbox-label input:checked + .checkbox-custom {
  background: #667eea;
  border-color: #667eea;
}

.checkbox-label input:checked + .checkbox-custom::after {
  content: '✓';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
  font-weight: bold;
}

.checkbox-text {
  font-size: 14px;
}

/* Alertes */
.alert {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-radius: 6px;
  margin-bottom: 20px;
  position: relative;
}

.alert-success {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
}

.alert-error {
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
}

.alert-info {
  background: #d1ecf1;
  border: 1px solid #bee5eb;
  color: #0c5460;
}

.alert i {
  font-size: 18px;
}

.alert-close {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: auto;
  color: inherit;
  opacity: 0.7;
}

.alert-close:hover {
  opacity: 1;
}

/* Boutons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  border-radius: 6px;
  border: 1px solid transparent;
  background: #e9ecef;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-primary {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

.btn-primary:hover {
  background: #5a6fd8;
  border-color: #5a6fd8;
}

.btn-outline {
  background: transparent;
  border-color: #dee2e6;
  color: #495057;
}

.btn-outline:hover {
  background: #f8f9fa;
  border-color: #adb5bd;
}

.btn-danger {
  background: #dc3545;
  color: white;
  border-color: #dc3545;
}

.btn-danger:hover {
  background: #c82333;
  border-color: #bd2130;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}

/* En-tête */
.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.header-actions {
  display: flex;
  gap: 10px;
}

/* Utilitaires */
.mt-10 { margin-top: 10px; }
.mr-5 { margin-right: 5px; }
.mr-10 { margin-right: 10px; }
.text-muted { color: #6c757d; }
</style>
{% endblock %}