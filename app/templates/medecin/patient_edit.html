{% extends 'medecin/base.html' %}

{% block title %}Modifier Patient • Médecin{% endblock %}

{% block content %}
<div class="card">
  <h2>Modifier le patient</h2>
  <input type="hidden" id="patientId" value="{{ pid }}">
  
  <form id="patientEditForm">
    <div class="form-group">
      <label>Nom complet *</label>
      <input name="nom" id="nom" class="input" required>
    </div>
    <div class="form-group">
      <label>Email *</label>
      <input name="email" id="email" type="email" class="input" required>
    </div>
    <div class="form-group">
      <label>Téléphone</label>
      <input name="telephone" id="telephone" class="input">
    </div>
    <div style="display:flex; gap:10px;">
      <button type="submit" class="btn primary">Mettre à jour</button>
      <a href="/medecin/patients" class="btn secondary">Annuler</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const patientId = document.getElementById('patientId').value;

async function loadPatientData() {
    try {
        const response = await fetch(`/medecin/api/patients/${patientId}`);
        
        if (!response.ok) {
            throw new Error('Patient non trouvé');
        }
        
        const patient = await response.json();
        
        document.getElementById('nom').value = patient.nom || '';
        document.getElementById('email').value = patient.email || '';
        document.getElementById('telephone').value = patient.telephone || '';
        
    } catch (error) {
        alert('❌ Erreur: ' + error.message);
        window.location.href = '/medecin/patients';
    }
}

document.getElementById('patientEditForm').addEventListener('submit', async function(e){
    e.preventDefault();
    
    const payload = {
        nom: document.getElementById('nom').value.trim(),
        email: document.getElementById('email').value.trim(),
        telephone: document.getElementById('telephone').value.trim()
    };

    try {
        const res = await fetch(`/medecin/api/patients/${patientId}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || 'Erreur lors de la mise à jour');
        }
        
        const result = await res.json();
        alert('✅ ' + (result.message || 'Patient mis à jour avec succès !'));
        window.location.href = '/medecin/patients';
        
    } catch (error) {
        alert('❌ Erreur: ' + error.message);
    }
});

document.addEventListener('DOMContentLoaded', loadPatientData);
</script>
{% endblock %}