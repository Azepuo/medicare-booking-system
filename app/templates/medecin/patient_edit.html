{% extends "medecin/base.html" %}

{% block title %}Modifier Patient • Médecin{% endblock %}

{% block content %}
<div class="card">
  <h2>Modifier le patient</h2>

  <form id="patientEditForm">
    <input type="hidden" id="patientId" value="{{ patient.id }}">

    <!-- NOM -->
    <div class="form-group">
      <label>Nom complet *</label>
      <input type="text" id="nom" class="input" value="{{ patient.nom }}" required>
    </div>

    <!-- EMAIL -->
    <div class="form-group">
      <label>Email *</label>
      <input type="email" id="email" class="input" value="{{ patient.email }}" required>
    </div>

    <!-- TELEPHONE -->
    <div class="form-group">
      <label>Téléphone</label>
      <input type="text" id="telephone" class="input" value="{{ patient.telephone }}">
    </div>

    <!-- SEXE -->
    <div class="form-group">
      <label>Sexe *</label>
      <select id="sexe" class="input" required>
        <option value="">-- Sélectionner --</option>
        <option value="Homme" {{ 'selected' if patient.sexe == 'Homme' else '' }}>Homme</option>
        <option value="Femme" {{ 'selected' if patient.sexe == 'Femme' else '' }}>Femme</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; margin-top:15px;">
      <button type="submit" class="btn primary">Mettre à jour</button>
      <a href="/medecin/patients" class="btn secondary">Annuler</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('patientEditForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const id = document.getElementById('patientId').value;

  const payload = {
    nom: document.getElementById('nom').value.trim(),
    email: document.getElementById('email').value.trim(),
    telephone: document.getElementById('telephone').value.trim(),
    sexe: document.getElementById('sexe').value
  };

  if (!payload.nom || !payload.email || !payload.sexe) {
    alert("❌ Champs obligatoires manquants");
    return;
  }

  try {
    const response = await fetch(`/medecin/api/patients/${id}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const err = await response.json().catch(()=>({}));
      throw new Error(err.error || 'Erreur serveur');
    }

    alert('✅ Patient modifié avec succès');
    window.location.href = '/medecin/patients';

  } catch (error) {
    alert('❌ ' + error.message);
  }
});
</script>
{% endblock %}
