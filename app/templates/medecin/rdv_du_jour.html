{% extends "medecin/base.html" %}

{% block title %}Rendez-vous du jour ‚Ä¢ M√©decin{% endblock %}

{% block body_id %}rdv-page{% endblock %}

{% block content %}
<div class="header-row">
  <h1 class="h1">Rendez-vous du Jour</h1>
  <div>
    <button class="btn secondary" onclick="filterRDV('all')">
      <i class="fas fa-list"></i> Tous
    </button>
    <button class="btn" onclick="refreshRDV()">
      <i class="fas fa-sync-alt"></i> Actualiser
    </button>
  </div>
</div>

<!-- Filtres rapides -->
<div class="card" style="margin-bottom: 20px;">
  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <button class="btn secondary" onclick="filterRDV('all')">
      Tous les RDV
    </button>
    <button class="btn secondary" onclick="filterRDV('confirmed')">
      <i class="fas fa-check-circle"></i> Confirm√©s
    </button>
    <button class="btn secondary" onclick="filterRDV('pending')">
      <i class="fas fa-clock"></i> En attente
    </button>
    <button class="btn secondary" onclick="filterRDV('cancelled')">
      <i class="fas fa-times-circle"></i> Annul√©s
    </button>
  </div>
</div>

<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>Heure</th>
        <th>Patient</th>
        <th>Motif</th>
        <th>Contact</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="rdvTable">
      <!-- RDV 1 -->
      <tr data-status="confirmed" data-id="1">
        <td>09:00</td>
        <td>
          <strong>Marie Dupont</strong>
          <div class="small">45 ans</div>
        </td>
        <td>Consultation g√©n√©rale</td>
        <td>
          <div class="small">üìû 01 23 45 67 89</div>
          <div class="small">‚úâÔ∏è marie.dupont@email.com</div>
        </td>
        <td>
          <span class="badge badge-success">
            <i class="fas fa-check-circle"></i> Confirm√©
          </span>
        </td>
        <td>
          <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <button class="btn" onclick="startConsultation(1)">
              <i class="fas fa-play"></i> D√©marrer
            </button>
            <button class="btn secondary" onclick="cancelRDV(1)">
              <i class="fas fa-times"></i> Annuler
            </button>
          </div>
        </td>
      </tr>

      <!-- RDV 2 -->
      <tr data-status="confirmed" data-id="2">
        <td>10:30</td>
        <td>
          <strong>Pierre Martin</strong>
          <div class="small">52 ans</div>
        </td>
        <td>Suivi traitement</td>
        <td>
          <div class="small">üìû 01 34 56 78 90</div>
          <div class="small">‚úâÔ∏è pierre.martin@email.com</div>
        </td>
        <td>
          <span class="badge badge-success">
            <i class="fas fa-check-circle"></i> Confirm√©
          </span>
        </td>
        <td>
          <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <button class="btn" onclick="startConsultation(2)">
              <i class="fas fa-play"></i> D√©marrer
            </button>
            <button class="btn secondary" onclick="cancelRDV(2)">
              <i class="fas fa-times"></i> Annuler
            </button>
          </div>
        </td>
      </tr>

      <!-- RDV 3 - En attente de confirmation -->
      <tr data-status="pending" data-id="3">
        <td>11:15</td>
        <td>
          <strong>Sophie Lambert</strong>
          <div class="small">38 ans</div>
        </td>
        <td>Vaccination</td>
        <td>
          <div class="small">üìû 01 45 67 89 01</div>
          <div class="small">‚úâÔ∏è sophie.lambert@email.com</div>
        </td>
        <td>
          <span class="badge badge-warning">
            <i class="fas fa-clock"></i> En attente
          </span>
        </td>
        <td>
          <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <button class="btn" onclick="confirmRDV(3)">
              <i class="fas fa-check"></i> Confirmer
            </button>
            <button class="btn secondary" onclick="cancelRDV(3)">
              <i class="fas fa-times"></i> Refuser
            </button>
          </div>
        </td>
      </tr>

      <!-- RDV 6 - Nouveau en attente -->
      <tr data-status="pending" data-id="6">
        <td>17:30</td>
        <td>
          <strong>Thomas Moreau</strong>
          <div class="small">34 ans</div>
        </td>
        <td>Premi√®re consultation</td>
        <td>
          <div class="small">üìû 01 78 90 12 34</div>
          <div class="small">‚úâÔ∏è thomas.moreau@email.com</div>
        </td>
        <td>
          <span class="badge badge-warning">
            <i class="fas fa-clock"></i> En attente
          </span>
        </td>
        <td>
          <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <button class="btn" onclick="confirmRDV(6)">
              <i class="fas fa-check"></i> Confirmer
            </button>
            <button class="btn secondary" onclick="cancelRDV(6)">
              <i class="fas fa-times"></i> Refuser
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Statistiques du jour -->
<!-- Statistiques du jour - Version Dynamique -->
<div class="grid" style="margin-top: 20px;">
  <div class="card">
    <h3>Total RDV</h3>
    <p id="totalRDV" class="stat-number">0</p>
    <div class="small">Aujourd'hui</div>
  </div>
  <div class="card">
    <h3>Confirm√©s</h3>
    <p id="confirmedRDV" class="stat-number">0</p>
    <div class="small" id="confirmedPercent">0%</div>
  </div>
  <div class="card">
    <h3>En Attente</h3>
    <p id="pendingRDV" class="stat-number">0</p>
    <div class="small" id="pendingPercent">0%</div>
  </div>
  <div class="card">
    <h3>Annul√©s</h3>
    <p id="cancelledRDV" class="stat-number">0</p>
    <div class="small" id="cancelledPercent">0%</div>
  </div>
</div>
<!-- Modal de confirmation -->
<div id="confirmationModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Confirmation</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div id="modalBody">
      <p>√ätes-vous s√ªr de vouloir effectuer cette action ?</p>
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
      <button class="btn secondary" onclick="closeModal()">Annuler</button>
      <button class="btn" id="modalConfirmBtn">Confirmer</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentAction = null;
let currentRDVId = null;

function refreshRDV() {
  alert('Liste des rendez-vous actualis√©e !');
  updateStatistics();
}

function filterRDV(status) {
  const rows = document.querySelectorAll('#rdvTable tr');
  rows.forEach(row => {
    if (status === 'all' || row.dataset.status === status) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function confirmRDV(rdvId) {
  currentRDVId = rdvId;
  currentAction = 'confirm';
  
  const patientName = document.querySelector(`tr[data-id="${rdvId}"] strong`).textContent;
  document.getElementById('modalTitle').textContent = 'Confirmer le rendez-vous';
  document.getElementById('modalBody').innerHTML = `
    <p>Confirmer le rendez-vous de <strong>${patientName}</strong> ?</p>
    <p>Le patient recevra une notification de confirmation.</p>
  `;
  document.getElementById('modalConfirmBtn').innerHTML = '<i class="fas fa-check"></i> Confirmer';
  document.getElementById('confirmationModal').style.display = 'flex';
}

function cancelRDV(rdvId) {
  currentRDVId = rdvId;
  const status = document.querySelector(`tr[data-id="${rdvId}"]`).dataset.status;
  currentAction = status === 'pending' ? 'refuse' : 'cancel';
  
  const patientName = document.querySelector(`tr[data-id="${rdvId}"] strong`).textContent;
  const actionText = status === 'pending' ? 'Refuser' : 'Annuler';
  
  document.getElementById('modalTitle').textContent = `${actionText} le rendez-vous`;
  document.getElementById('modalBody').innerHTML = `
    <p>${actionText} le rendez-vous de <strong>${patientName}</strong> ?</p>
    <div class="form-group">
      <label class="form-label">Raison (optionnel) :</label>
      <textarea id="cancelReason" class="input" placeholder="Ex: Cr√©neau indisponible, patient a report√©..." rows="3" style="width: 100%;"></textarea>
    </div>
  `;
  document.getElementById('modalConfirmBtn').innerHTML = `<i class="fas fa-times"></i> ${actionText}`;
  document.getElementById('confirmationModal').style.display = 'flex';
}

function startConsultation(rdvId) {
  if (confirm('D√©marrer la consultation pour ce rendez-vous ?')) {
    alert(`Consultation #${rdvId} d√©marr√©e !`);
    // Redirection vers la page de consultation
    // window.location.href = `/medecin/consultation/${rdvId}`;
  }
}

function rescheduleRDV(rdvId) {
  const patientName = document.querySelector(`tr[data-id="${rdvId}"] strong`).textContent;
  const newDate = prompt(`Reprogrammer le rendez-vous avec ${patientName} (nouvelle date) :`, '2024-01-16 10:00');
  if (newDate) {
    alert(`Rendez-vous reprogramm√© au ${newDate}`);
    // Ici, vous feriez un appel API pour reprogrammer
  }
}

function deleteRDV(rdvId) {
  if (confirm('Supprimer d√©finitivement ce rendez-vous annul√© ?')) {
    alert(`Rendez-vous #${rdvId} supprim√©`);
    // Ici, vous feriez un appel API pour supprimer
  }
}

function executeAction() {
  const reason = document.getElementById('cancelReason') ? document.getElementById('cancelReason').value : '';
  
  switch(currentAction) {
    case 'confirm':
      alert(`Rendez-vous #${currentRDVId} confirm√© !`);
      updateRDVStatus(currentRDVId, 'confirmed');
      break;
    case 'cancel':
      alert(`Rendez-vous #${currentRDVId} annul√©${reason ? ` : ${reason}` : ''}`);
      updateRDVStatus(currentRDVId, 'cancelled');
      break;
    case 'refuse':
      alert(`Rendez-vous #${currentRDVId} refus√©${reason ? ` : ${reason}` : ''}`);
      updateRDVStatus(currentRDVId, 'cancelled');
      break;
  }
  
  closeModal();
  updateStatistics();
}

function updateRDVStatus(rdvId, newStatus) {
  const row = document.querySelector(`tr[data-id="${rdvId}"]`);
  const statusCell = row.querySelector('td:nth-child(5)');
  const actionsCell = row.querySelector('td:nth-child(6)');
  
  row.dataset.status = newStatus;
  
  if (newStatus === 'confirmed') {
    statusCell.innerHTML = '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Confirm√©</span>';
    actionsCell.innerHTML = `
      <div style="display: flex; gap: 5px; flex-wrap: wrap;">
        <button class="btn" onclick="startConsultation(${rdvId})">
          <i class="fas fa-play"></i> D√©marrer
        </button>
        <button class="btn secondary" onclick="cancelRDV(${rdvId})">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    `;
  } else if (newStatus === 'cancelled') {
    statusCell.innerHTML = '<span class="badge badge-error"><i class="fas fa-times-circle"></i> Annul√©</span>';
    actionsCell.innerHTML = `
      <div style="display: flex; gap: 5px; flex-wrap: wrap;">
        <button class="btn secondary" onclick="rescheduleRDV(${rdvId})">
          <i class="fas fa-calendar-plus"></i> Reprogrammer
        </button>
        <button class="btn secondary" onclick="deleteRDV(${rdvId})">
          <i class="fas fa-trash"></i> Supprimer
        </button>
      </div>
    `;
  }
}

function updateStatistics() {
  const total = document.querySelectorAll('#rdvTable tr').length;
  const confirmed = document.querySelectorAll('#rdvTable tr[data-status="confirmed"]').length;
  const pending = document.querySelectorAll('#rdvTable tr[data-status="pending"]').length;
  const cancelled = document.querySelectorAll('#rdvTable tr[data-status="cancelled"]').length;
  
  document.getElementById('totalRDV').textContent = total;
  document.getElementById('confirmedRDV').textContent = confirmed;
  document.getElementById('pendingRDV').textContent = pending;
  document.getElementById('cancelledRDV').textContent = cancelled;
}

function closeModal() {
  document.getElementById('confirmationModal').style.display = 'none';
  currentAction = null;
  currentRDVId = null;
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  updateStatistics();
  document.getElementById('modalConfirmBtn').addEventListener('click', executeAction);
});

// Styles pour le modal
const modalStyle = `
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  padding: 24px;
  border-radius: 16px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-bottom: 1px solid #f1f6fb;
  padding-bottom: 15px;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

.modal-close:hover {
  color: var(--text);
}
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = modalStyle;
document.head.appendChild(styleSheet);
</script>
{% endblock %}