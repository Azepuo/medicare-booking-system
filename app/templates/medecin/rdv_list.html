{% extends "medecin/base.html" %}

{% block content %}
<div class="header-row">
  <h1 class="h1">Rendez-vous du Jour</h1>
  <div class="header-actions">
    <button class="btn primary" onclick="window.location.href='/medecin/rdv/add'">
      <i class="fas fa-plus"></i> Nouveau RDV
    </button>
    <button class="btn" onclick="refreshRDV()">
      <i class="fas fa-sync-alt"></i> Actualiser
    </button>
  </div>
</div>

<div class="card mt-15">
  <div class="table-responsive">
    <table class="table rdv-table">
      <thead>
        <tr>
          <th class="col-hour">Heure</th>
          <th class="col-patient">Patient</th>
          <th class="col-motif">Motif</th>
          <th class="col-contact">Contact</th>
          <th class="col-status">Statut</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody id="rdvTable"></tbody>
    </table>
  </div>

  <div id="noDataMessage" class="no-data" style="display: none;">
    <p>Aucun rendez-vous aujourd'hui</p>
  </div>
</div>

<div class="grid stats-grid mt-20"> 
  <div class="stat-card">
    <div class="stat-icon icon-blue"><i class="fas fa-calendar-day"></i></div>
    <div>
      <p class="stat-number" id="totalRDV">0</p>
      <p class="stat-label">Total RDV</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon icon-green"><i class="fas fa-check-circle"></i></div>
    <div>
      <p class="stat-number" id="confirmedRDV">0</p>
      <p class="stat-label">Confirmés</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon icon-yellow"><i class="fas fa-hourglass-half"></i></div>
    <div>
      <p class="stat-number" id="pendingRDV">0</p>
      <p class="stat-label">En Attente</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon icon-red"><i class="fas fa-times-circle"></i></div>
    <div>
      <p class="stat-number" id="cancelledRDV">0</p>
      <p class="stat-label">Annulés</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_ROUTES = {
  LIST_TODAY: '/medecin/api/rendezvous/today',
  DELETE: '/medecin/api/rendezvous'
};

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
}

function showLoading() {
  const tbody = document.getElementById('rdvTable');
  tbody.innerHTML = '<tr><td colspan="6" class="centered-cell">Chargement...</td></tr>';
}

function showNoData() {
  document.getElementById('rdvTable').style.display = 'none';
  document.getElementById('noDataMessage').style.display = 'block';
}

function showTable() {
  document.getElementById('rdvTable').style.display = 'table-row-group';
  document.getElementById('noDataMessage').style.display = 'none';
}

async function renderRDV() {
  showLoading();
  try {
    const res = await fetch(API_ROUTES.LIST_TODAY);
    if (!res.ok) throw new Error(`Erreur ${res.status}: ${res.statusText}`);
    const rdvs = await res.json();

    const tbody = document.getElementById('rdvTable');
    tbody.innerHTML = '';

    if (!rdvs || rdvs.length === 0) {
      showNoData();
      updateStatistics(rdvs);
      return;
    }

    showTable();
    rdvs.forEach(rdv => {
      const tr = document.createElement('tr');
      tr.dataset.status = rdv.statut || '';
      tr.dataset.id = rdv.id || '';

      let heure = rdv.date_heure ? rdv.date_heure.split(' ')[1]?.slice(0,5) : '';
      tr.innerHTML = `
        <td class="cell-hour">${escapeHtml(heure)}</td>
        <td class="cell-patient"><strong>${escapeHtml(rdv.patient_nom || 'N/A')}</strong></td>
        <td class="cell-motif">${escapeHtml(rdv.notes || 'Non spécifié')}</td>
        <td class="cell-contact">${escapeHtml(rdv.patient_telephone || 'N/A')}</td>
        <td class="cell-status"><span class="status-badge">${escapeHtml(rdv.statut || 'Inconnu')}</span></td>
        <td class="cell-actions">
          <div class="actions">
            <button class="btn action-btn" onclick="goEdit(${rdv.id})">Modifier</button>
            <button class="btn action-btn danger" onclick="confirmDelete(${rdv.id})">Supprimer</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
    updateStatistics(rdvs);

  } catch (error) {
    console.error('Erreur renderRDV:', error);
    const tbody = document.getElementById('rdvTable');
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="centered-cell error-cell">
          ❌ Erreur: ${escapeHtml(error.message)}<br><br>
          <button class="btn action-btn" onclick="renderRDV()">Réessayer</button>
        </td>
      </tr>
    `;
    showTable();
  }
}

async function deleteRDV(id) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer ce rendez-vous ?')) return;
  try {
    const res = await fetch(`${API_ROUTES.DELETE}/${id}`, { method: 'DELETE' });
    if (!res.ok) {
      const errorData = await res.json().catch(()=>({}));
      throw new Error(errorData.error || `Erreur ${res.status}`);
    }
    const result = await res.json().catch(()=>({}));
    alert('✅ ' + (result.message || 'Rendez-vous supprimé avec succès'));
    renderRDV();
  } catch (error) {
    console.error(error);
    alert('❌ Erreur: ' + error.message);
  }
}

function goEdit(id) { window.location.href = `/medecin/rdv/edit/${id}`; }

function updateStatistics(rdvs = null) {
  let total=0, confirmed=0, pending=0, cancelled=0;
  if (rdvs) {
    total = rdvs.length;
    confirmed = rdvs.filter(r => r.statut === 'Confirmé').length;
    pending = rdvs.filter(r => r.statut === 'En attente').length;
    cancelled = rdvs.filter(r => r.statut === 'Annulé').length;
  } else {
    const rows = document.querySelectorAll('#rdvTable tr[data-status]');
    total = rows.length;
    confirmed = Array.from(rows).filter(r => r.dataset.status==='Confirmé').length;
    pending = Array.from(rows).filter(r => r.dataset.status==='En attente').length;
    cancelled = Array.from(rows).filter(r => r.dataset.status==='Annulé').length;
  }
  document.getElementById('totalRDV').textContent = total;
  document.getElementById('confirmedRDV').textContent = confirmed;
  document.getElementById('pendingRDV').textContent = pending;
  document.getElementById('cancelledRDV').textContent = cancelled;
}

function refreshRDV() { renderRDV(); }

document.addEventListener('DOMContentLoaded', renderRDV);
setInterval(renderRDV, 120000); // rafraîchissement auto toutes les 2 min
</script>
{% endblock %}
