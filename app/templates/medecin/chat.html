{% extends "medecin/base.html" %}

{% block title %}Chat • Médecin{% endblock %}

{% block body_id %}chat-page{% endblock %}

{% block content %}
<div class="header-row">
  <h1 class="h1">Messagerie</h1>
  <button class="btn" onclick="refreshMessages()">
    <i class="fas fa-sync-alt"></i> Actualiser
  </button>
</div>

<div style="display: flex; gap: 20px; height: 600px;">
  <!-- Liste des conversations -->
  <div class="card" style="flex: 1; max-width: 300px;">
    <h3>Conversations</h3>
    <div style="margin-top: 15px;">
      <div class="chat-contact active" onclick="selectConversation(1)">
        <div style="width: 40px; height: 40px; background: var(--blue-500); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
          MD
        </div>
        <div style="flex: 1;">
          <strong>Marie Dupont</strong>
          <div class="small">Dernier message reçu...</div>
        </div>
        <span class="badge badge-success">3</span>
      </div>
      <div class="chat-contact" onclick="selectConversation(2)">
        <div style="width: 40px; height: 40px; background: var(--blue-500); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
          PM
        </div>
        <div style="flex: 1;">
          <strong>Pierre Martin</strong>
          <div class="small">OK, merci docteur</div>
        </div>
      </div>
      <div class="chat-contact" onclick="selectConversation(3)">
        <div style="width: 40px; height: 40px; background: var(--blue-500); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
          SL
        </div>
        <div style="flex: 1;">
          <strong>Sophie Lambert</strong>
          <div class="small">Bonjour, je voudrais prendre...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fenêtre de chat -->
  <div class="card" style="flex: 2; display: flex; flex-direction: column;">
    <div class="chat-header">
      <div style="display: flex; align-items: center; gap: 10px;">
        <div style="width: 40px; height: 40px; background: var(--blue-500); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
          MD
        </div>
        <div>
          <strong>Marie Dupont</strong>
          <div class="small">En ligne</div>
        </div>
      </div>
    </div>

    <div class="chat-window" id="chatMessages">
      <div class="msg other">
        <strong>Marie Dupont:</strong> Bonjour docteur, je voulais savoir si je peux prendre RDV pour la semaine prochaine ?
      </div>
      <div class="msg me">
        Bonjour Marie, oui bien sûr. Je vous propose jeudi à 14h ou vendredi à 10h.
      </div>
      <div class="msg other">
        <strong>Marie Dupont:</strong> Jeudi 14h me convient parfaitement, merci !
      </div>
      <div class="msg me">
        Parfait, c'est noté. N'oubliez pas d'apporter vos derniers examens.
      </div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <input type="text" class="input" id="messageInput" placeholder="Tapez votre message..." style="flex: 1;" />
      <button class="btn" id="sendMessageBtn">
        <i class="fas fa-paper-plane"></i> Envoyer
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentConversation = 1;

function selectConversation(conversationId) {
  currentConversation = conversationId;
  // Mettre à jour l'interface
  document.querySelectorAll('.chat-contact').forEach(contact => {
    contact.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  
  // Charger les messages de la conversation
  loadMessages(conversationId);
}

function loadMessages(conversationId) {
  // Simulation de chargement des messages
  const messages = {
    1: [
      { type: 'other', text: 'Bonjour docteur, je voulais savoir si je peux prendre RDV pour la semaine prochaine ?' },
      { type: 'me', text: 'Bonjour Marie, oui bien sûr. Je vous propose jeudi à 14h ou vendredi à 10h.' },
      { type: 'other', text: 'Jeudi 14h me convient parfaitement, merci !' },
      { type: 'me', text: 'Parfait, c\'est noté. N\'oubliez pas d\'apporter vos derniers examens.' }
    ]
  };
  
  const chatWindow = document.getElementById('chatMessages');
  chatWindow.innerHTML = messages[conversationId].map(msg => 
    `<div class="msg ${msg.type}">${msg.text}</div>`
  ).join('');
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function refreshMessages() {
  loadMessages(currentConversation);
  alert('Messages actualisés !');
}

document.getElementById('sendMessageBtn').addEventListener('click', function() {
  const input = document.getElementById('messageInput');
  const message = input.value.trim();
  
  if (message) {
    const chatWindow = document.getElementById('chatMessages');
    chatWindow.innerHTML += `<div class="msg me">${message}</div>`;
    input.value = '';
    chatWindow.scrollTop = chatWindow.scrollHeight;
    
    // Simulation de réponse automatique
    setTimeout(() => {
      chatWindow.innerHTML += `<div class="msg other"><strong>Marie Dupont:</strong> Merci pour votre réponse !</div>`;
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }, 1000);
  }
});

document.getElementById('messageInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    document.getElementById('sendMessageBtn').click();
  }
});

// Chargement initial
document.addEventListener('DOMContentLoaded', function() {
  loadMessages(1);
});
</script>

<style>
.chat-contact {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

.chat-contact:hover {
  background: var(--blue-100);
}

.chat-contact.active {
  background: var(--blue-100);
  border-left: 3px solid var(--blue-500);
}

.chat-header {
  padding: 15px;
  border-bottom: 1px solid #f1f6fb;
  margin-bottom: 15px;
}
</style>
{% endblock %}