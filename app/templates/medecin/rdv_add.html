{% extends 'medecin/base.html' %}

{% block title %}Nouveau Rendez-vous • Médecin{% endblock %}

{% block content %}
<div class="card">
  <h2>Nouveau rendez-vous</h2>
  <form id="rdvAddForm">
    <div class="form-group">
      <label>Patient *</label>
      <select name="patient_id" id="patient_id" class="input" required>
        <option value="">Sélectionner un patient...</option>
      </select>
    </div>

    <div class="form-group">
      <label>Motif de la consultation</label>
      <textarea name="notes" id="notes" class="input" rows="3" placeholder="Décrire le motif de la consultation..."></textarea>
    </div>

    <div class="form-group">
      <label>Date et heure du rendez-vous *</label>
      <input type="datetime-local" name="date_heure" id="date_heure" class="input" required>
    </div>

    <div class="form-group">
      <label>Statut</label>
      <select name="statut" id="statut" class="input">
        <option value="En attente">En attente</option>
        <option value="Confirmé">Confirmé</option>
        <option value="Annulé">Annulé</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; margin-top: 20px;">
      <button type="submit" class="btn primary">Planifier le rendez-vous</button>
      <a href="/medecin/rdv" class="btn secondary">Annuler</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Charger la liste des patients
async function loadPatients() {
  try {
    const response = await fetch('/medecin/api/patients');
    if (!response.ok) throw new Error(`Erreur ${response.status}: ${response.statusText}`);
    const patients = await response.json();
    
    const patientSelect = document.getElementById('patient_id');
    patientSelect.innerHTML = '<option value="">Sélectionner un patient...</option>';
    
    if (patients && patients.length > 0) {
      patients.forEach(patient => {
        const option = document.createElement('option');
        option.value = patient.id;
        option.textContent = `${patient.nom} - ${patient.email}${patient.telephone ? ` - ${patient.telephone}` : ''}`;
        patientSelect.appendChild(option);
      });
    } else {
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'Aucun patient disponible';
      patientSelect.appendChild(option);
    }
  } catch (error) {
    console.error('Erreur chargement patients:', error);
    alert('Erreur lors du chargement de la liste des patients: ' + error.message);
  }
}

// Soumission du formulaire
document.getElementById('rdvAddForm').addEventListener('submit', async function(e){
  e.preventDefault();
  
  const payload = {
    patient_id: parseInt(document.getElementById('patient_id').value),
    date_heure: document.getElementById('date_heure').value,
    statut: document.getElementById('statut').value,
    notes: document.getElementById('notes').value.trim()
  };

  if (!payload.patient_id) { alert('Veuillez sélectionner un patient'); return; }
  if (!payload.date_heure) { alert('Veuillez sélectionner une date et heure'); return; }

  try {
    const response = await fetch('/medecin/api/rendezvous', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(()=>({}));
      throw new Error(errorData.error || `Erreur ${response.status}`);
    }
    
    const result = await response.json().catch(()=>({}));
    alert('✅ ' + (result.message || 'Rendez-vous planifié avec succès !'));
    window.location.href = '/medecin/rdv';
    
  } catch (error) {
    console.error('Erreur création RDV:', error);
    alert('❌ Erreur: ' + error.message);
  }
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  loadPatients();
  
  const now = new Date();
  now.setHours(now.getHours() + 1);
  now.setMinutes(0);
  const datetimeLocal = now.toISOString().slice(0, 16);
  document.getElementById('date_heure').value = datetimeLocal;
});
</script>
{% endblock %}
