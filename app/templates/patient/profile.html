{% extends "patient/base.html" %}

{% block title %}Mon Profil - WeCare{% endblock %}

{% block page_title %}Mon Compte{% endblock %}

{% block header %}
<!-- Cacher le header pour la page profil -->
<div style="display: none;">
    {{ super() }}
</div>
{% endblock %}

{% block content %}
<div class="content" id="accountContent">
    <div class="account-container">
        <div class="account-header">
            <h1 class="account-title">
                <i class="fas fa-user-circle"></i>
                Mon Compte
            </h1>
            <p class="account-subtitle">Gérez vos informations personnelles</p>
        </div>
<div id="flashMessage" class="flash-message" style="display:none;"></div>

        <div class="account-content">

            <!-- Carte Profil -->
            <div class="profile-section">
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <div class="avatar-large">{{ patient.nom[0]|upper }}</div>
                            <button class="btn-change-avatar">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        <div class="profile-info">
                            <h2 class="profile-name">{{ patient.nom }}</h2>
                            <p class="profile-email">{{ patient.email }}</p>
                            <p class="profile-role">Patient</p>
                        </div>
                    </div>

                    <div class="profile-stats">
                        <div class="profile-stat">
                            <span class="stat-number">{{ stats.rdv_count if stats else 0 }}</span>
                            <span class="stat-label">Rendez-vous</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations Personnelles -->
            <div class="personal-info-section">
                <div class="section-card">
                    <div class="section-header">
                        <h3>
                            <i class="fas fa-user"></i>
                            Informations Personnelles
                        </h3>
                        <button class="btn-edit" id="btnEdit">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                    </div>

                    <form id="personalInfoForm" class="info-form" method="POST" action="{{ url_for('patient.update_profile') }}">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nom">Nom Complet</label>
                                <input type="text" id="nom" name="nom" class="form-control"
                                       value="{{ patient.nom }}" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" class="form-control"
                                       value="{{ patient.email }}" readonly>
                            </div>
                            <div class="form-group">
                                <label for="telephone">Téléphone</label>
                                <input type="tel" id="telephone" name="telephone" class="form-control"
                                       value="{{ patient.telephone }}" readonly>
                            </div>
                        </div>

                        <div class="form-actions" id="personalInfoActions" style="display: none;">
                            <button type="button" class="btn-cancel" onclick="cancelEdit('personalInfoForm')">Annuler</button>
                            <button type="submit" class="btn-save">Enregistrer</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('personalInfoForm');
    const btnEdit = document.getElementById('btnEdit');
    const actions = document.getElementById('personalInfoActions');
    const flashMessage = document.getElementById('flashMessage');

    function showMessage(message, type) {
        flashMessage.textContent = message;
        flashMessage.className = 'flash-message ' + (type === 'success' ? 'flash-success' : 'flash-error');
        flashMessage.style.display = 'block';
        setTimeout(() => {
            flashMessage.style.opacity = 0;
            setTimeout(() => { flashMessage.style.display = 'none'; flashMessage.style.opacity = 1; }, 500);
        }, 3000);
    }

    btnEdit.addEventListener('click', function() {
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => input.removeAttribute('readonly'));
        actions.style.display = 'flex';
    });

    const btnCancel = actions.querySelector('.btn-cancel');
    btnCancel.addEventListener('click', function() {
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => input.setAttribute('readonly', true));
        actions.style.display = 'none';
    });

form.addEventListener('submit', function(e) {
    e.preventDefault();
    const nom = form.querySelector('#nom').value.trim();
    const email = form.querySelector('#email').value.trim();
    const telephone = form.querySelector('#telephone').value.trim();

    if (!nom || !email || !telephone) {
        showMessage("Tous les champs sont requis.", 'error');
        return;
    }

    const formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            const inputs = form.querySelectorAll('input');
            inputs.forEach(input => input.setAttribute('readonly', true));
            actions.style.display = 'none';
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(err => {
        console.error(err);
        showMessage("Erreur serveur.", 'error');
    });
});

});
</script>
{% endblock %}