{% extends "medecin/base.html" %}

{% block content %}
<div class="header-row">
  <h1 class="h1">Mes Disponibilit√©s</h1>
  <div class="header-actions">
    <button class="btn primary" onclick="window.location.href='/medecin/disponibilites/add'">
      <i class="fas fa-plus"></i> Nouvelle Disponibilit√©
    </button>
    <button class="btn" onclick="refreshDispo()">
      <i class="fas fa-sync-alt"></i> Actualiser
    </button>
  </div>
</div>

<!-- Onglets pour filtrer -->
<div class="tabs mt-15">
  <button class="tab-btn active" onclick="showTodayDispo()">
    <i class="fas fa-calendar-day"></i> Aujourd'hui
  </button>
  <button class="tab-btn" onclick="showAllDispo()">
    <i class="fas fa-calendar-week"></i> Toutes
  </button>
</div>

<div class="card mt-15">
  <div class="table-responsive">
    <table class="table dispo-table">
      <thead>
        <tr>
          <th class="col-jour">Jour</th>
          <th class="col-heure">Heure D√©but</th>
          <th class="col-heure">Heure Fin</th>
          <th class="col-duree">Dur√©e</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody id="dispoTable"></tbody>
    </table>
  </div>
</div>

<div class="grid stats-grid mt-20"> 
  <div class="stat-card">
    <div class="stat-icon icon-blue"><i class="fas fa-clock"></i></div>
    <div>
      <p class="stat-number" id="totalDispo">0</p>
      <p class="stat-label">Total Cr√©neaux</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon icon-green"><i class="fas fa-calendar-check"></i></div>
    <div>
      <p class="stat-number" id="todayDispo">0</p>
      <p class="stat-label">Aujourd'hui</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon icon-purple"><i class="fas fa-business-time"></i></div>
    <div>
      <p class="stat-number" id="totalHeures">0h</p>
      <p class="stat-label">Heures/Semaine</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon icon-orange"><i class="fas fa-calendar-alt"></i></div>
    <div>
      <p class="stat-number" id="joursDispo">0</p>
      <p class="stat-label">Jours Actifs</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Routes API POUR DISPONIBILITES
const DISPO_API = {
  LIST_TODAY: '/medecin/rpc/disponibilites/list?today=1',
  LIST_ALL: '/medecin/rpc/disponibilites/list',
  DELETE: '/medecin/rpc/disponibilites/delete'
};
let currentView = 'today';
let globalDispoStats = {
  total: 0,
  today: 0,
  totalHeures: 0,
  joursActifs: 0
};

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
}

function formatHeure(heureStr) {
  if (!heureStr) return '';
  try {
    // Si c'est une string avec des deux-points
    if (typeof heureStr === 'string' && heureStr.includes(':')) {
      const [heures, minutes] = heureStr.split(':');
      return `${heures.padStart(2, '0')}:${minutes.padStart(2, '0')}`;
    }
    return String(heureStr);
  } catch (e) {
    return heureStr;
  }
}

// FONCTION CALCULER DUR√âE
function calculerDuree(debut, fin) {
  if (!debut || !fin) return '';
  
  try {
    // Convertir les heures en minutes
    const [h1, m1] = debut.split(':').map(Number);
    const [h2, m2] = fin.split(':').map(Number);
    
    const totalMinutes1 = h1 * 60 + m1;
    const totalMinutes2 = h2 * 60 + m2;
    
    if (totalMinutes2 <= totalMinutes1) {
      return '0h';
    }
    
    const difference = totalMinutes2 - totalMinutes1;
    const heures = Math.floor(difference / 60);
    const minutes = difference % 60;
    
    if (heures === 0) return `${minutes}min`;
    if (minutes === 0) return `${heures}h`;
    return `${heures}h${minutes.toString().padStart(2, '0')}`;
  } catch (e) {
    console.error('Erreur calculerDuree:', e);
    return '';
  }
}

async function renderDispo(viewType = 'today') {
  currentView = viewType;
  const tbody = document.getElementById('dispoTable');
  tbody.innerHTML = '<tr><td colspan="5" class="centered-cell">Chargement...</td></tr>';
  
  try {
    const apiUrl = viewType === 'today' ? DISPO_API.LIST_TODAY : DISPO_API.LIST_ALL;
    
    console.log(`DEBUG: Appel API: ${apiUrl}`);
    
    const res = await fetch(apiUrl, {
      credentials: 'include'
    });
    
    console.log(`DEBUG: R√©ponse status: ${res.status}`);
    
    if (!res.ok) {
      let errorMessage = `Erreur ${res.status}`;
      try {
        const errorData = await res.json();
        errorMessage = errorData.error || errorMessage;
      } catch {
        // Garder le message par d√©faut
      }
      throw new Error(errorMessage);
    }
    
    const data = await res.json();
    console.log('DEBUG: Donn√©es re√ßues:', data);
    
    if (!data.ok) {
      throw new Error(data.error || 'Erreur serveur');
    }
    
    const dispoList = data.data || [];
    tbody.innerHTML = '';
    
    if (dispoList.length === 0) {
      let message = 'Aucune disponibilit√©';
      if (viewType === 'today') {
        message = data.today ? 
          `Aucune disponibilit√© programm√©e pour le ${data.today}` : 
          'Aucune disponibilit√© aujourd\'hui';
      }
      tbody.innerHTML = `<tr><td colspan="5" class="centered-cell">${message}</td></tr>`;
      return;
    }
    
    console.log(`DEBUG: ${dispoList.length} disponibilit√©s trouv√©es`);
    
    dispoList.forEach(dispo => {
      const tr = document.createElement('tr');
      tr.dataset.id = dispo.id;
      
      // Utiliser les champs d'affichage si disponibles
      const heureDebut = dispo.heure_debut_display || dispo.heure_debut;
      const heureFin = dispo.heure_fin_display || dispo.heure_fin;
      const duree = calculerDuree(heureDebut, heureFin);
      
      tr.innerHTML = `
        <td class="cell-jour"><strong>${escapeHtml(dispo.jour_semaine)}</strong></td>
        <td class="cell-heure">${formatHeure(heureDebut)}</td>
        <td class="cell-heure">${formatHeure(heureFin)}</td>
        <td class="cell-duree">${duree}</td>
        <td class="cell-actions">
          <div class="actions">
            <button class="btn action-btn" onclick="goEditDispo(${dispo.id})">Modifier</button>
            <button class="btn action-btn danger" onclick="confirmDeleteDispo(${dispo.id})">Supprimer</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
    
    // Mettre √† jour les onglets actifs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    if (viewType === 'today') {
      document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
    } else {
      document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
    }
    
  } catch (error) {
    console.error('Erreur renderDispo:', error);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="centered-cell error-cell">
          ‚ùå Erreur: ${escapeHtml(error.message)}
          <br><br>
          <button class="btn" onclick="renderDispo(currentView)">R√©essayer</button>
          <br><br>
          <small>URL: ${viewType === 'today' ? DISPO_API.LIST_TODAY : DISPO_API.LIST_ALL}</small>
        </td>
      </tr>
    `;
  }
}

function calculerHeuresMinutes(debut, fin) {
  try {
    const [h1, m1] = debut.split(':').map(Number);
    const [h2, m2] = fin.split(':').map(Number);
    const totalMinutes1 = h1 * 60 + m1;
    const totalMinutes2 = h2 * 60 + m2;
    return totalMinutes2 - totalMinutes1;
  } catch (e) {
    return 0;
  }
}

async function loadGlobalDispoStatistics() {
  try {
    const res = await fetch(DISPO_API.LIST_ALL, {
      credentials: 'include'
    });
    
    if (!res.ok) {
      let errorMessage = `Erreur ${res.status}`;
      try {
        const errorData = await res.json();
        errorMessage = errorData.error || errorMessage;
      } catch {
        // Garder le message par d√©faut
      }
      throw new Error(errorMessage);
    }
    
    const data = await res.json();
    
    if (!data.ok) {
      throw new Error(data.error || 'Erreur serveur');
    }
    
    const allDispo = data.data || [];
    
    // Calculer les statistiques globales
    globalDispoStats.total = allDispo.length;
    
    // Calculer le total des heures par semaine
    let totalMinutes = 0;
    allDispo.forEach(dispo => {
      const heureDebut = dispo.heure_debut_display || dispo.heure_debut;
      const heureFin = dispo.heure_fin_display || dispo.heure_fin;
      const duree = calculerHeuresMinutes(heureDebut, heureFin);
      totalMinutes += duree;
    });
    
    globalDispoStats.totalHeures = Math.round(totalMinutes / 60);
    
    // Compter les jours uniques
    const joursUniques = [...new Set(allDispo.map(d => d.jour_semaine))];
    globalDispoStats.joursActifs = joursUniques.length;
    
    // Charger les disponibilit√©s d'aujourd'hui pour la statistique "Aujourd'hui"
    try {
      const todayRes = await fetch(DISPO_API.LIST_TODAY, {
        credentials: 'include'
      });
      
      if (todayRes.ok) {
        const todayData = await todayRes.json();
        if (todayData.ok) {
          globalDispoStats.today = todayData.data ? todayData.data.length : 0;
        }
      }
    } catch (todayError) {
      console.warn('Erreur lors du chargement des disponibilit√©s du jour:', todayError);
      globalDispoStats.today = 0;
    }
    
    // Mettre √† jour l'affichage des statistiques
    updateDispoStatisticsDisplay();
    
  } catch (error) {
    console.error('Erreur lors du chargement des statistiques globales:', error);
  }
}

function updateDispoStatisticsDisplay() {
  document.getElementById('totalDispo').textContent = globalDispoStats.total;
  document.getElementById('todayDispo').textContent = globalDispoStats.today;
  document.getElementById('totalHeures').textContent = `${globalDispoStats.totalHeures}h`;
  document.getElementById('joursDispo').textContent = globalDispoStats.joursActifs;
}

async function confirmDeleteDispo(id) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette disponibilit√© ?')) return;
  
  try {
    const res = await fetch(`${DISPO_API.DELETE}/${id}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || 'Erreur suppression');
    }
    
    if (!data.ok) {
      throw new Error(data.error || 'Erreur suppression');
    }
    
    alert('‚úÖ Disponibilit√© supprim√©e avec succ√®s');
    // Recharger les statistiques globales et la vue actuelle
    await loadGlobalDispoStatistics();
    renderDispo(currentView);
    
  } catch (error) {
    console.error('Erreur suppression:', error);
    alert('‚ùå Erreur: ' + error.message);
  }
}

function goEditDispo(id) {
  window.location.href = `/medecin/disponibilites/edit/${id}`;
}

function showTodayDispo() {
  renderDispo('today');
}

function showAllDispo() {
  renderDispo('all');
}

function refreshDispo() {
  // Recharger les statistiques globales et la vue actuelle
  loadGlobalDispoStatistics();
  renderDispo(currentView);
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  // Charger les statistiques globales (toutes les disponibilit√©s)
  loadGlobalDispoStatistics();
  
  // Afficher la vue par d√©faut (aujourd'hui)
  showTodayDispo();
});

// Actualisation automatique toutes les 2 minutes
setInterval(() => refreshDispo(), 120000);

// Styles CSS
const style = document.createElement('style');
style.textContent = `
.tabs{
  display:flex;
  gap:4px;
  background:#e8f4ff;
  padding:3px;
  border-radius:6px;
  border:1px solid #c2e0ff;
  box-shadow:0 1px 2px rgba(137,207,240,.12);
  width:fit-content;
}

.tab-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:4px;
  padding:6px 10px;
  background:transparent;
  border:none;
  border-radius:5px;
  font-size:13px;        /* üî• taille augment√©e */
  font-weight:600;
  color:#4a90e2;
  cursor:pointer;
  transition:all .2s ease;
  position:relative;
  overflow:hidden;
  white-space:nowrap;
}

.tab-btn i{
  font-size:13px;        /* üî• ic√¥ne plus grande */
}

.tab-btn:hover{
  background:#d4ecff;
  color:#357abd;
}

.tab-btn.active{
  background:linear-gradient(135deg,#89cff0 0%,#b6d8f2 100%);
  color:#fff;
  border:1px solid #8ac6f0;
  box-shadow:0 1px 3px rgba(137,207,240,.25);
}

.tab-btn.active::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:2px;
  background:linear-gradient(90deg,#4a90e2,#89cff0);
}

.tab-btn:active{
  transform:scale(.96);
}

.tab-btn:focus{
  outline:none;
  box-shadow:0 0 0 2px rgba(137,207,240,.35);
}

.tab-btn.has-notification::after{
  content:'';
  position:absolute;
  top:4px;
  right:4px;
  width:5px;
  height:5px;
  background:#ff6b6b;
  border-radius:50%;
}

/* Mobile */
@media (max-width:640px){
  .tab-btn{
    padding:5px 8px;
    font-size:12px;      /* üî• mobile lisible */
  }
  .tab-btn i{
    font-size:12px;
  }
}
`;
document.head.appendChild(style);
</script>


<style>
/* Styles pour les cartes de statistiques */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border: 1px solid #e8e8e8;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 15px;
  min-height: 100px;
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
  border-color: #007bff;
}

.stat-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  flex-shrink: 0;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.stat-icon.icon-blue {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

.stat-icon.icon-green {
  background: linear-gradient(135deg, #10b981, #059669);
}

.stat-icon.icon-purple {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.stat-icon.icon-orange {
  background: linear-gradient(135deg, #f59e0b, #d97706);
}

.stat-icon.icon-red {
  background: linear-gradient(135deg, #ef4444, #dc2626);
}

.stat-icon i {
  filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
}

.stat-content {
  flex: 1;
}

.stat-number {
  font-size: 28px;
  font-weight: 700;
  margin: 0;
  line-height: 1.2;
  color: #1f2937;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.stat-label {
  font-size: 14px;
  color: #6b7280;
  margin: 5px 0 0 0;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Animation pour les nombres qui changent */
.stat-number {
  transition: all 0.3s ease;
}

.stat-number.changing {
  transform: scale(1.1);
  color: #007bff;
}

/* Responsive */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
  
  .stat-card {
    padding: 15px;
    min-height: 90px;
  }
  
  .stat-icon {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }
  
  .stat-number {
    font-size: 24px;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
}

/* Animation au chargement */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.stat-card {
  animation: fadeInUp 0.5s ease forwards;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }
.stat-card:nth-child(4) { animation-delay: 0.4s; }

/* Badge pour les statistiques qui ont des donn√©es */
.stat-card.has-data {
  border-left: 4px solid #10b981;
}

/* Variante sombre pour les th√®mes sombres */
@media (prefers-color-scheme: dark) {
  .stat-card {
    background: #1f2937;
    border-color: #374151;
  }
  
  .stat-number {
    color: #f9fafb;
  }
  
  .stat-label {
    color: #9ca3af;
  }
}
</style>
{% endblock %}