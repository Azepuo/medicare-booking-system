{% extends 'medecin/base.html' %}

{% block title %}Modifier Rendez-vous • Médecin{% endblock %}

{% block content %}
<div class="card">
  <h2>Modifier un rendez-vous</h2>
  <form id="rdvEditForm">
    <input type="hidden" id="rdv_id">
    
    <div class="form-group">
      <label>Patient *</label>
      <select name="patient_id" id="patient_id" class="input" required>
        <option value="">Sélectionner un patient...</option>
      </select>
    </div>

    <div class="form-group">
      <label>Motif de la consultation</label>
      <textarea name="notes" id="notes" class="input" rows="3" placeholder="Décrire le motif de la consultation..."></textarea>
    </div>

    <div class="form-group">
      <label>Date et heure du rendez-vous *</label>
      <input type="datetime-local" name="date_heure" id="date_heure" class="input" required>
    </div>

    <div class="form-group">
      <label>Statut</label>
      <select name="statut" id="statut" class="input">
        <option value="En attente">En attente</option>
        <option value="Confirmé">Confirmé</option>
        <option value="Annulé">Annulé</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; margin-top: 20px;">
      <button type="submit" class="btn primary">Sauvegarder</button>
      <a href="/medecin/rdv?all=1" class="btn secondary">Annuler</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Charger les patients pour le select
async function loadPatients(selectedId = null) {
  try {
    const response = await fetch('/medecin/api/patients', {
      credentials: 'include'
    });
    
    if (!response.ok) {
      if (response.status === 401 || response.status === 403) {
        alert('Session expirée. Redirection vers la page de connexion...');
        window.location.href = '/login';
        return;
      }
      throw new Error(`Erreur ${response.status}`);
    }
    
    const patients = await response.json();
    
    const select = document.getElementById('patient_id');
    select.innerHTML = '<option value="">Sélectionner un patient...</option>';
    
    patients.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = p.nom + (p.email ? ` - ${p.email}` : '');
      if (selectedId && selectedId === p.id) option.selected = true;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Erreur chargement patients:', error);
    alert('Impossible de charger les patients');
  }
}

// Charger les infos du RDV
async function loadRdv(rdvId) {
  try {
    // Récupérer tous les RDV et filtrer par ID
    const res = await fetch('/medecin/rpc/rdv/list', {
      credentials: 'include'
    });
    
    if (!res.ok) {
      if (res.status === 401 || res.status === 403) {
        alert('Session expirée. Veuillez vous reconnecter.');
        window.location.href = '/login';
        return;
      }
      throw new Error(`Erreur ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    
    if (!data.ok) {
      throw new Error(data.error || 'Erreur serveur');
    }
    
    // Trouver le RDV avec l'ID correspondant
    const rdv = data.data.find(r => r.id == rdvId);
    
    if (!rdv) {
      throw new Error('Rendez-vous non trouvé');
    }
    
    // Remplir le formulaire
    document.getElementById('rdv_id').value = rdv.id;
    document.getElementById('notes').value = rdv.notes || '';
    
    // Formater la date pour le champ datetime-local
    if (rdv.date_heure) {
      const date = new Date(rdv.date_heure);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      document.getElementById('date_heure').value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    document.getElementById('statut').value = rdv.statut || 'En attente';
    
    // Charger les patients avec le patient sélectionné
    loadPatients(rdv.patient_id);
    
  } catch (error) {
    console.error('Erreur loadRdv:', error);
    alert('❌ Erreur: ' + error.message);
  }
}

// Soumission du formulaire
document.getElementById('rdvEditForm').addEventListener('submit', async function(e){
  e.preventDefault();
  
  const payload = {
    patient_id: parseInt(document.getElementById('patient_id').value),
    date_heure: document.getElementById('date_heure').value,
    statut: document.getElementById('statut').value,
    notes: document.getElementById('notes').value.trim()
  };

  // Validation
  if (!payload.patient_id || !payload.date_heure) {
    alert('Veuillez remplir tous les champs obligatoires');
    return;
  }

  const rdvId = document.getElementById('rdv_id').value;

  try {
    const res = await fetch(`/medecin/rpc/rdv/update/${rdvId}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify(payload)
    });
    
    const contentType = res.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const text = await res.text();
      console.error('Réponse non JSON:', text.substring(0, 200));
      throw new Error('Réponse serveur invalide');
    }
    
    const data = await res.json();
    console.log('Réponse du serveur:', data);
    
    if (!res.ok) {
      if (res.status === 401) {
        alert('Session expirée. Veuillez vous reconnecter.');
        window.location.href = '/login';
        return;
      }
      
      if (res.status === 403) {
        alert('Accès non autorisé. Vous devez être médecin pour modifier un rendez-vous.');
        window.location.href = '/login';
        return;
      }
      
      if (res.status === 404) {
        if (data.error && data.error.includes('Rendez-vous non trouvé')) {
          alert('Erreur: Le rendez-vous n\'existe pas ou a été supprimé.');
          window.location.href = '/medecin/rdv?all=1';
          return;
        }
      }
      
      throw new Error(data.error || `Erreur serveur (${res.status})`);
    }
    
    if (!data.ok) {
      throw new Error(data.error || 'Erreur lors de la mise à jour du rendez-vous');
    }
    
    alert('✅ Rendez-vous mis à jour avec succès !');
    // Rediriger vers la page qui montre TOUS les rendez-vous
    window.location.href = '/medecin/rdv?all=1';

  } catch (error) {
    console.error('Erreur update RDV:', error);
    alert('❌ Erreur: ' + error.message);
  }
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  // Récupérer l'ID du RDV depuis l'URL
  const pathParts = window.location.pathname.split('/');
  const rdvId = pathParts[pathParts.length - 1];
  
  if (rdvId && !isNaN(rdvId)) {
    loadRdv(rdvId);
  } else {
    alert('ID de rendez-vous invalide');
    window.location.href = '/medecin/rdv';
  }
  
  // Définir la date minimale pour le champ datetime (aujourd'hui)
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  
  const minDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
  document.getElementById('date_heure').min = minDateTime;
});
</script>
{% endblock %}